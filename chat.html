<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Keyboard Input for chat-bubble</title>

    <!-- for mobile screens -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- stylesheets are conveniently separated into components -->
    <link rel="stylesheet" media="all" href="component/styles/setup.css">
    <link rel="stylesheet" media="all" href="component/styles/says.css">
    <link rel="stylesheet" media="all" href="component/styles/reply.css">
    <link rel="stylesheet" media="all" href="component/styles/typing.css">
    <link rel="stylesheet" media="all" href="component/styles/input.css">
    <style>
        body {
            background: #dcdde0;
        }

        .bubble-container {
            height: 100vh;
        }

        .bubble-container .input-wrap textarea {
            margin: 0;
            width: calc(100% - 30px);
        }

    </style>
</head>

<body>

    <!-- container element for chat window -->
    <div id="chat"></div>

    <!-- import the JavaScript file -->
    <script src="component/Bubbles.js"></script>
    <script>
        // initialize by constructing a named function...
        // ...and add text processing plugin:
        var chatWindow = new Bubbles(document.getElementById("chat"), "chatWindow", {
            // the one that we care about is inputCallbackFn()
            // this function returns an object with some data that we can process from user input
            // and understand the context of it

            // this is an example function that matches the text user typed to one of the answer bubbles
            // this function does no natural language processing
            // this is where you may want to connect this script to NLC backend.
            inputCallbackFn: function (o) {
                // add error conversation block & recall it if no answer matched
                var miss = function () {
                    chatWindow.talk(
                        {
                            "i-dont-get-it": {
                                says: [
                                    "抱歉没能理解您的意思, 我以关闭非业务聊天能力, 可尝试如下输入"
                                ],
                                // reply: o.convo[o.standingAnswer].reply
                                reply: [
                                    {
                                        question: "查看灾难",
                                        answer: "wild-fire"
                                    },
                                    {
                                        question: "查看供应商列表",
                                        answer: "vendor-list"
                                    },
                                    {
                                        question: "查看生效的通知",
                                        answer: "notification-list"
                                    },
                                    {
                                        question: "从头再来",
                                        answer: "ice"
                                    }
                                ]
                            }
                        },
                        "i-dont-get-it"
                    )
                }

                // do this if answer found
                var match = function (key) {
                    setTimeout(function () {

                        chatWindow.talk(convo, key) // restart current convo from point found in the answer
                    }, 600)
                }

                // sanitize text for search function
                var strip = function (text) {
                    return text.toLowerCase().replace(/[\s.,\/#!$%\^&\*;:{}=\-_'"`~()]/g, "")
                }

                // search function
                var found = false
                /*
                for (const dialog of o.convo) {
                    dialog.reply.forEach(function (e, i) {
                        strip(e.question).includes(strip(o.input)) && o.input.length > 0
                            ? (found = e.answer)
                            : found ? null : (found = false)
                    })
                    if (found) { break; }
                }
                found ? match(found) : miss()
                */


                // o.convo.forEach(function (dialog, i) {
                //     dialog.reply.forEach(function (e, i) {
                //         strip(e.question).includes(strip(o.input)) && o.input.length > 0
                //             ? (found = e.answer)
                //             : found ? null : (found = false)
                //     })
                //     if (found) { return; }
                // })


                o.convo[o.standingAnswer].reply.forEach(function (e, i) {
                    strip(e.question).includes(strip(o.input)) && o.input.length > 0
                        ? (found = e.answer)
                        : found ? null : (found = false)
                })
                found ? match(found) : miss()

            }
        }) // done setting up chat-bubble

        // conversation object defined separately, but just the same as in the
        // "Basic chat-bubble Example" (1-basics.html)

        var convo = {
            ice: { // the starting point 
                says: ["我是灾难大模型", "欢迎回来, David!", "最近美国加州发生了野火, 但公司最近没有项目使用加州的供应商, 是否查看野火造成的影响?"],
                reply: [
                    {
                        question: "查看野火",
                        answer: "wild-fire"
                    },
                    {
                        question: "查看供应商信息",
                        answer: "vendor-list"
                    },
                    {
                        question: "查看生效的通知",
                        answer: "notification-list"
                    }
                ]
            },
            "wild-fire": {
                says: [`这场高地大火的规模从周一（30日）晚到周二（31日）几乎扩大了一倍。
                截至周二晚上，加州森林消防局（Cal Fire）已控制约10%的火势。`],
                reply: [
                    {
                        question: "是否有原材料会间接受到影响?",
                        answer: "affected"
                    }, {
                        question: "更新供应商信息",
                        answer: "vendor-update"
                    }
                ]
            },
            "vendor-list": {
                says: [`这场高地大火的规模从周一（30日）晚到周二（31日）几乎扩大了一倍。
                截至周二晚上，加州森林消防局（Cal Fire）已控制约10%的火势。`],
                reply: [
                    {
                        question: "是否有原材料会间接受到影响?",
                        answer: "affected"
                    }, {
                        question: "更新供应商信息",
                        answer: "vendor-update"
                    }
                ]
            },
            "notification-list": {
                says: [`这场高地大火的规模从周一（30日）晚到周二（31日）几乎扩大了一倍。
                截至周二晚上，加州森林消防局（Cal Fire）已控制约10%的火势。`],
                reply: [
                    {
                        question: "是否有原材料会间接受到影响?",
                        answer: "affected"
                    }, {
                        question: "更新供应商信息",
                        answer: "vendor-update"
                    }
                ]
            },
            banana: {
                says: ["🍌"],
                reply: [
                    {
                        question: "Start Over",
                        answer: "ice"
                    }
                ]
            },
            "ice-cream": {
                says: ["🍦"],
                reply: [
                    {
                        question: "Start Over",
                        answer: "ice"
                    }
                ]
            }
        }

        // pass JSON to your function and you're done!
        chatWindow.talk(convo)
    </script>
</body>
